<!DOCTYPE html>
<html lang="uk" x-data="{
  mobileMenu: false,
  messengerOptions: [
    { label: 'Telegram', icon: 'https://cdn.jsdelivr.net/npm/simple-icons@9/icons/telegram.svg' },
    { label: 'Viber',    icon: 'https://cdn.jsdelivr.net/npm/simple-icons@9/icons/viber.svg' },
    { label: 'WhatsApp', icon: 'https://cdn.jsdelivr.net/npm/simple-icons@9/icons/whatsapp.svg' },
    { label: 'Signal',   icon: 'https://cdn.jsdelivr.net/npm/simple-icons@9/icons/signal.svg' }
  ],
  messengerOpen: false,
  selectedMessenger: null
}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è ‚Äî Banobox</title>
  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="assets/css/style.css">
  <!-- Banobox Cart Logic -->
  <script defer src="assets/js/banobox.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <!-- Header -->
  <header class="bg-white shadow-md fixed w-full z-50">
    <div class="container mx-auto flex justify-between items-center p-4">
      <a href="index.html" class="text-2xl font-bold text-blue-600">Banobox</a>
      <nav class="hidden md:flex space-x-6">
        <a href="index.html" class="hover:text-blue-600">–ì–æ–ª–æ–≤–Ω–∞</a>
        <a href="cart.html" class="hover:text-blue-600">–ö–æ—à–∏–∫</a>
      </nav>
      <button class="md:hidden" @click="mobileMenu=!mobileMenu" aria-label="–ú–µ–Ω—é">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>
    </div>
    <nav x-show="mobileMenu" class="md:hidden bg-white shadow-inner">
      <a href="index.html" class="block p-2 hover:bg-gray-100">–ì–æ–ª–æ–≤–Ω–∞</a>
      <a href="cart.html" class="block p-2 hover:bg-gray-100">–ö–æ—à–∏–∫</a>
    </nav>
  </header>

  <main class="pt-24 container mx-auto p-4 max-w-2xl">
    <h1 class="text-2xl font-bold mb-4">–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>
    <form id="order-form" class="space-y-4">
      <input type="text" id="name" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ –Ü–º'—è –ü–æ –±–∞—Ç—å–∫–æ–≤—ñ" class="w-full p-2 border rounded" required>
      <input type="tel" id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" class="w-full p-2 border rounded" required>

      <!-- Custom Messenger dropdown -->
      <div class="relative">
        <button type="button" @click="messengerOpen = !messengerOpen"
                class="w-full flex items-center p-2 border rounded bg-white">
          <template x-if="selectedMessenger">
            <img :src="selectedMessenger.icon" class="w-5 h-5 mr-2" alt="">
          </template>
          <span x-text="selectedMessenger ? selectedMessenger.label : '–û–±–µ—Ä—ñ—Ç—å –º–µ—Å–µ–Ω–¥–∂–µ—Ä –¥–ª—è –∑–≤‚Äô—è–∑–∫—É –∑ –≤–∞–º–∏'"></span>
          <svg class="ml-auto w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M6 9l6 6 6-6"/>
          </svg>
        </button>
        <div x-show="messengerOpen" @click.away="messengerOpen = false"
             class="absolute mt-1 bg-white border rounded shadow w-full z-10">
          <template x-for="opt in messengerOptions" :key="opt.label">
            <div @click="selectedMessenger = opt; $refs.msgInput.value = opt.label; messengerOpen = false"
                 class="flex items-center p-2 hover:bg-gray-100 cursor-pointer">
              <img :src="opt.icon" class="w-5 h-5 mr-2" alt="">
              <span x-text="opt.label"></span>
            </div>
          </template>
        </div>
        <input type="hidden" id="messenger" x-ref="msgInput" required>
      </div>

      <input type="text" id="city" placeholder="–ú—ñ—Å—Ç–æ" class="w-full p-2 border rounded" required>
      <input type="text" id="branch" placeholder="–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è" class="w-full p-2 border rounded" required>
      <textarea id="comment" placeholder="–ö–æ–º–µ–Ω—Ç–∞—Ä (—è–∫—â–æ –ø–æ—à—Ç–æ–º–∞—Ç ‚Äî –≤–∫–∞–∂—ñ—Ç—å —Ç—É—Ç –∫–æ–¥ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è)"
                class="w-full p-2 border rounded" rows="3"></textarea>

      <button type="submit" id="submit-order" class="btn-primary w-full py-2">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
      <p id="order-status" class="text-sm text-gray-600"></p>
    </form>
  </main>

  <script>
    // ‚ö†Ô∏è –ö—Ä–∞—â–µ –≤–∏–Ω–µ—Å—Ç–∏ –≤ –±–µ–∫–µ–Ω–¥ —ñ –ù–ï —Ç—Ä–∏–º–∞—Ç–∏ —É —Ñ—Ä–æ–Ω—Ç—ñ!
    const BOT_TOKEN = "8406792358:AAEIvhTQD3xtvcM-ZahvR3NHqHTeC4tMomk";
    const CHAT_ID   = "487717612";

    function calcUnitPrice(item) {
      // —Ü—ñ–Ω–∞ –∑–∞ –æ–¥–∏–Ω–∏—Ü—é –ó –£–†–ê–•–£–í–ê–ù–ù–Ø–ú –∑–Ω–∏–∂–∫–∏ (—â–æ–± –∑–±—ñ–≥–∞–≤—Å—è total –Ω–∞ –±–µ–∫–µ–Ω–¥—ñ)
      const price = Number(item.price || 0);
      const discount = Number(item.discount || 0);
      return discount ? +(price * (100 - discount) / 100).toFixed(2) : +price.toFixed(2);
    }

    function makeTelegramMessage(form, cart) {
      let msg = `üßæ –ù–æ–≤–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
üë§ –ö–ª—ñ—î–Ω—Ç: ${form.name.value}
üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${form.phone.value}
üí¨ –ú–µ—Å–µ–Ω–¥–∂–µ—Ä: ${form.messenger.value}
üöö –ú—ñ—Å—Ç–æ: ${form.city.value}
üè¢ –í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è: ${form.branch.value}
`;
      if (form.comment.value) msg += `üí≠ –ö–æ–º–µ–Ω—Ç–∞—Ä: ${form.comment.value}\n`;

      cart.forEach((i, idx) => {
        const unit = calcUnitPrice(i);
        msg += `\n${idx+1}. ${i.title} (POS ${i.pos})` +
               (i.volume ? `, –æ–±‚Äô—î–º: ${i.volume}` : '') +
               (i.color  ? `, –∫–æ–ª—ñ—Ä: ${i.color}`   : '') +
               `\n   ‚Ç¥${unit} x ${i.quantity} = ‚Ç¥${(unit*i.quantity).toFixed(2)}\n`;
      });

      const total = cart.reduce((s,i) => s + calcUnitPrice(i)*Number(i.quantity||0), 0).toFixed(2);
      msg += `\nüí∞ –†–∞–∑–æ–º: ‚Ç¥${total}`;
      return msg;
    }

    async function sendTelegram(msg) {
      try {
        const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chat_id: CHAT_ID, text: msg })
        });
        return res.ok;
      } catch {
        return false;
      }
    }

    async function createOrderOnServer(cart, customer) {
      // –§–æ—Ä–º—É—î–º–æ payload –ø—ñ–¥ –Ω–∞—à /api/order
      // item: pos, quantity, price (–∑—ñ –∑–Ω–∏–∂–∫–æ—é), color_id?/volume_id? + —Ä–µ–∑–µ—Ä–≤–Ω—ñ –Ω–∞–∑–≤–∏ color/volume
      const normalizedCart = cart.map(i => ({
        pos: i.pos,
        quantity: Number(i.quantity || 0),
        price: calcUnitPrice(i),
        // —è–∫—â–æ –≤ –∫–æ—à–∏–∫—É —î –∞–π–¥—ñ ‚Äî –Ω–∞–¥—Å–∏–ª–∞—î–º–æ; —ñ–Ω–∞–∫—à–µ –Ω–µ—Ö–∞–π –±–µ–∫ –º–∞–ø–∏—Ç—å –ø–æ –Ω–∞–∑–≤—ñ
        color_id:  i.color_id ?? null,
        volume_id: i.volume_id ?? null,
        color:     i.color ?? null,
        volume:    i.volume ?? null
      }));

      const payload = { cart: normalizedCart, customer };

      // same-origin ‚áí cookie —Å–µ—Å—ñ—ó –ø–æ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—é –ø–æ—ó–¥—É—Ç—å (credentials: 'same-origin')
      const res = await fetch('/api/order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        // 401 ‚Äî –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏–π, —ñ–Ω—à—ñ ‚Äî –ø–æ–º–∏–ª–∫–∏ –ë–î/–≤–∞–ª—ñ–¥–∞—Ü—ñ—ó
        let err = '–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è';
        try { const j = await res.json(); if (j.error) err = j.error; } catch {}
        throw new Error(err);
      }
      return res.json(); // { orderId }
    }

    document.getElementById('order-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const f = e.currentTarget;
      const btn = document.getElementById('submit-order');
      const status = document.getElementById('order-status');

      let cart = JSON.parse(localStorage.getItem('banobox_cart') || '[]');
      if (!Array.isArray(cart) || cart.length === 0) {
        alert('–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π'); return;
      }
      // –ü—Ä–æ—Å—Ç–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è —Ç–µ–ª–µ—Ñ–æ–Ω—É (–º—ñ–Ω—ñ–º—É–º 9 —Ü–∏—Ñ—Ä)
      const digits = (f.phone.value || '').replace(/\D/g, '');
      if (digits.length < 9) {
        alert('–í–∫–∞–∂—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω'); return;
      }

      btn.disabled = true;
      btn.textContent = '–í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ...';
      status.textContent = '–°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è...';

      const customer = {
        name: f.name.value.trim(),
        phone: f.phone.value.trim(),
        messenger: f.messenger.value.trim(),
        city: f.city.value.trim(),
        branch: f.branch.value.trim(),
        comment: f.comment.value.trim()
      };

      // 1) –°–ø—Ä–æ–±–∞ –∑–∞–ø–∏—Å–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤ –ë–î
      let serverOk = false, orderId = null;
      try {
        const { orderId: oid } = await createOrderOnServer(cart, customer);
        serverOk = true;
        orderId = oid;
        status.textContent = `–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Ññ${oid} –∑–±–µ—Ä–µ–∂–µ–Ω–æ. –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è...`;
      } catch (err) {
        // –Ø–∫—â–æ 401 ‚Äî –ø—Ä–æ—Å—Ç–æ —ñ–Ω—Ñ–æ—Ä–º—É—î–º–æ —ñ –π–¥–µ–º–æ –¥–∞–ª—ñ –∑ Telegram
        status.textContent = `–ù–µ –≤–¥–∞–ª–æ—Å—å –∑–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ (${err.message}). –ù–∞–¥—Å–∏–ª–∞—î–º–æ —á–µ—Ä–µ–∑ Telegram...`;
      }

      // 2) –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è —É Telegram (—â–æ–± –ø—Ä–æ–¥–∞–≤–µ—Ü—å –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ –æ—Ç—Ä–∏–º–∞–≤)
      const tgMsg = makeTelegramMessage(f, cart) + (orderId ? `\nüÜî OrderID: ${orderId}` : '');
      const tgOk = await sendTelegram(tgMsg);

      // 3) –§—ñ–Ω–∞–ª—ñ–∑–∞—Ü—ñ—è
      if (tgOk || serverOk) {
        localStorage.removeItem('banobox_cart');
        window.location.href = 'success.html';
      } else {
        btn.disabled = false;
        btn.textContent = '–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏';
        status.textContent = '–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –∑–≤‚Äô—è–∂—ñ—Ç—å—Å—è –∑ –Ω–∞–º–∏.';
        alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
      }
    });
  </script>
</body>
</html>
