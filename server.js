// server.js
const express      = require('express');
const path         = require('path');
const fs           = require('fs');
const bcrypt       = require('bcrypt');
const session      = require('express-session');
const SQLiteStore  = require('connect-sqlite3')(session);
const sqlite3      = require('sqlite3').verbose();

const app = express();

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 * –ë–ê–ó–û–í–ï –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø
 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

app.use(express.json());                                         // JSON
app.use(express.static(path.join(__dirname)));                   // —Å—Ç–∞—Ç–∏–∫–∞

// –°–µ—Å—ñ—ó (SQLite store —É /db)
app.use(session({
  store: new SQLiteStore({ db: 'sessions.sqlite', dir: './db' }),
  secret: 'banobox_secret_key',
  resave: false,
  saveUninitialized: false,
  cookie: { maxAge: 24*60*60*1000 }
}));

// –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è SQLite
const DBSOURCE = path.join(__dirname, 'db', 'DBbanobox.db');
const db = new sqlite3.Database(DBSOURCE, err => {
  if (err) console.error('SQLite connection error:', err.message);
  else console.log('üóÑÔ∏è Connected to DBbanobox.db');
});
db.run('PRAGMA foreign_keys = ON'); // –≤–º–∏–∫–∞—î–º–æ –∑–æ–≤–Ω—ñ—à–Ω—ñ –∫–ª—é—á—ñ

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 * –ú–Ü–ì–†–ê–¶–Ü–á (node server.js migrate)
 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
if (process.argv[2] === 'migrate') {
  const schemaPath = path.join(__dirname, 'db', 'database_schema.sql');
  if (!fs.existsSync(schemaPath)) {
    console.error('Schema file not found:', schemaPath);
    process.exit(1);
  }
  const schema = fs.readFileSync(schemaPath, 'utf8');
  db.exec(schema, err => {
    if (err) console.error('Migration error:', err.message);
    else console.log('‚úÖ Migrations applied');
    process.exit(0);
  });
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 * –ê–í–¢–ï–ù–¢–ò–§–Ü–ö–ê–¶–Ü–Ø
 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
app.post('/api/register', async (req, res) => {
  const { email, password, name } = req.body;
  if (!email || !password) return res.status(400).json({ error: 'Email & password required' });
  try {
    const hash = await bcrypt.hash(password, 10);
    db.run(
      `INSERT INTO users(email,password_hash,name) VALUES(?,?,?)`,
      [email, hash, name || ''],
      function(err) {
        if (err) return res.status(400).json({ error: 'User exists or DB error' });
        req.session.userId = this.lastID;
        res.json({ message: 'OK' });
      }
    );
  } catch (e) {
    res.status(500).json({ error: 'Hash error' });
  }
});

app.post('/api/login', (req, res) => {
  const { email, password } = req.body;
  db.get(`SELECT id,password_hash,name FROM users WHERE email = ?`, [email], async (err, row) => {
    if (err || !row) return res.status(400).json({ error: 'Invalid credentials' });
    const ok = await bcrypt.compare(password, row.password_hash);
    if (!ok) return res.status(400).json({ error: 'Invalid credentials' });
    req.session.userId = row.id;
    res.json({ message: 'OK', name: row.name });
  });
});

app.post('/api/logout', (req, res) => {
  req.session.destroy(() => res.json({ message: 'Logged out' }));
});

app.get('/api/me', (req, res) => {
  if (!req.session.userId) return res.json({ user: null });
  db.get(`SELECT id,name,email FROM users WHERE id = ?`, [req.session.userId], (e, row) => {
    res.json({ user: row || null });
  });
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 * –ì–û–õ–û–í–ù–ò–ô –†–û–£–¢–ï–† –ö–ê–¢–ê–õ–û–ì–£/–î–û–í–Ü–î–ù–ò–ö–Ü–í
 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const productRoutes = require('./server_routes');
app.use(productRoutes);

// ‚ö†Ô∏è –í–ê–ñ–õ–ò–í–û: –ù–ï –ø—ñ–¥–∫–ª—é—á–∞–π—Ç–µ —Ç—É—Ç server_orders_api ‚Äî –≤—ñ–Ω –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω
// const ordersApiRoutes = require('./server_orders_api'); // ‚Üê –ø—Ä–∏–±—Ä–∞—Ç–∏
// app.use(ordersApiRoutes);

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 * –û–§–û–†–ú–õ–ï–ù–ù–Ø –ó–ê–ú–û–í–õ–ï–ù–ù–Ø (insert –≤ orders + order_items)
 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 * –í—Ö—ñ–¥:
 * {
 *   cart: [ { pos, quantity, price, volume_id?, color_id?, volume?, color? } ],
 *   customer: { name, phone, messenger, city, branch, comment? }
 * }
 */
app.post('/api/order', (req, res) => {
  if (!req.session.userId) return res.status(401).json({ error: 'Not logged in' });

  const { cart = [], customer = {} } = req.body;
  if (!Array.isArray(cart) || cart.length === 0) {
    return res.status(400).json({ error: '–ü–æ—Ä–æ–∂–Ω—ñ–π –∫–æ—à–∏–∫' });
  }

  const total = cart.reduce((s, i) => s + Number(i.quantity || 0) * Number(i.price || 0), 0);

  db.run(
    `INSERT INTO orders(user_id,customer_name,customer_phone,customer_messenger,city,branch,comment,total)
     VALUES(?,?,?,?,?,?,?,?)`,
    [
      req.session.userId,
      customer.name,
      customer.phone,
      customer.messenger,
      customer.city,
      customer.branch,
      customer.comment || '',
      total
    ],
    function(err) {
      if (err) return res.status(500).json({ error: 'DB error' });

      const orderId = this.lastID;
      const stmt = db.prepare(
        `INSERT INTO order_items(order_id,product_id,quantity,unit_price,color_id,volume_id)
         VALUES(?,?,?,?,?,?)`
      );

      // –•–µ–ª–ø–µ—Ä–∏: –±–µ–∑–ø–µ—á–Ω–æ –¥—ñ—Å—Ç–∞—Ç–∏ id –æ–±'—î–º—É/–∫–æ–ª—å–æ—Ä—É –∑–∞ —Ç–µ–∫—Å—Ç–æ–º
      function resolveVolumeId(item, cb) {
        if (item.volume_id) return cb(null, Number(item.volume_id));
        if (!item.volume) return cb(null, null);
        db.get(`SELECT id FROM volumes WHERE volume = ?`, [item.volume], (e, v) => {
          if (e) return cb(e);
          cb(null, v ? v.id : null);
        });
      }
      function resolveColorId(item, cb) {
        if (item.color_id) return cb(null, Number(item.color_id));
        if (!item.color) return cb(null, null);
        db.get(`SELECT id FROM colors WHERE color_name = ?`, [item.color], (e, c) => {
          if (e) return cb(e);
          cb(null, c ? c.id : null);
        });
      }

      // –í—Å—Ç–∞–≤–ª—è—î–º–æ –ø–æ–∑–∏—Ü—ñ—ó
      let pending = cart.length;
      cart.forEach(item => {
        db.get(`SELECT id FROM products WHERE pos = ?`, [item.pos], (e1, pr) => {
          const pid = pr ? pr.id : null;
          resolveColorId(item, (e2, cid) => {
            if (e2) console.error('Color resolve error:', e2.message);
            resolveVolumeId(item, (e3, vid) => {
              if (e3) console.error('Volume resolve error:', e3.message);

              stmt.run(orderId, pid, item.quantity || 0, item.price || 0, cid, vid, err4 => {
                if (err4) console.error('order_items insert error:', err4.message);
                if (!--pending) {
                  stmt.finalize();
                  return res.json({ orderId });
                }
              });
            });
          });
        });
      });
    }
  );
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 * –•–ï–õ–ü–ï–†–ò ¬´–Ü–°–¢–û–†–Ü–á –ó–ê–ú–û–í–õ–ï–ù–¨¬ª
 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

// –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è URL —Ñ–æ—Ç–æ
function normUrl(u) {
  if (!u) return null;
  let x = String(u).replace(/\\/g,'/');
  if (!/^https?:\/\//i.test(x) && !x.startsWith('/')) x = '/' + x;
  return x;
}

// –ë–µ–∑–ø–µ—á–Ω–∏–π –≤–∏–±—ñ—Ä –ø–æ–ª—è: —á–∏ —ñ—Å–Ω—É—î –∫–æ–ª–æ–Ω–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü—ñ
function hasColumn(table, col) {
  return new Promise((resolve) => {
    db.all(`PRAGMA table_info(${table})`, [], (e, rows) => {
      if (e || !rows) return resolve(false);
      resolve(rows.some(r => String(r.name).toLowerCase() === String(col).toLowerCase()));
    });
  });
}

// –û—Ç—Ä–∏–º–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ –∑–∞–º–æ–≤–ª–µ–Ω—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –±–µ–∑ –∑–≤–µ—Ä–Ω–µ–Ω—å –¥–æ –Ω–µ—ñ—Å–Ω—É—é—á–∏—Ö –∫–æ–ª–æ–Ω–æ–∫
async function fetchOrdersListForUser(userId) {
  const cols = { total: await hasColumn('orders','total'),
                 created_at: await hasColumn('orders','created_at'),
                 city: await hasColumn('orders','city'),
                 branch: await hasColumn('orders','branch'),
                 comment: await hasColumn('orders','comment') };

  const sel = [
    'id',
    'user_id',
    cols.total     ? 'total'     : '0 AS total',
    cols.created_at? 'created_at': 'NULL AS created_at',
    cols.city      ? 'city'      : 'NULL AS city',
    cols.branch    ? 'branch'    : 'NULL AS branch',
    cols.comment   ? 'comment'   : 'NULL AS comment'
  ].join(', ');

  const orderBy = cols.created_at ? 'ORDER BY datetime(created_at) DESC' : 'ORDER BY id DESC';

  return new Promise((resolve, reject) => {
    db.all(
      `SELECT ${sel} FROM orders WHERE user_id = ? ${orderBy}`,
      [userId],
      (e, rows) => e ? reject(e) : resolve(rows || [])
    );
  });
}

// –í–∏—Ç—è–≥ –ø–æ–∑–∏—Ü—ñ–π –æ–¥–Ω–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–∏–º JOIN
// (—Ç—ñ–ª—å–∫–∏ order_items + products) ‚Äî –º—ñ–Ω—ñ–º—É–º —Ä–∏–∑–∏–∫—É 500-–æ–∫.
// –Ø–∫—â–æ –Ω–∞–≤—ñ—Ç—å order_items –Ω–µ–º–∞—î ‚Äî –ø—Ä–æ–±—É—î–º–æ orders.items_json; —è–∫—â–æ –π —Ü—å–æ–≥–æ –Ω–µ–º–∞ ‚Äî [].
// –í–∏—Ç—è–≥ –ø–æ–∑–∏—Ü—ñ–π –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ —Ñ–æ—Ç–æ:
// 1) –ü–û–í–ù–ò–ô JOIN (–≤–∫–ª—é—á–Ω–æ –∑ product_photos ‚Üí GROUP_CONCAT —Ñ–æ—Ç–æ);
// 2) —è–∫—â–æ —è–∫–∏—Ö–æ—Å—å —Ç–∞–±–ª–∏—Ü—å –Ω–µ–º–∞—î ‚Äî —Å–ø—Ä–æ—â–µ–Ω–∏–π JOIN –±–µ–∑ —Ñ–æ—Ç–æ;
// 3) —è–∫—â–æ –Ω–∞–≤—ñ—Ç—å order_items –Ω–µ–º–∞—î ‚Äî fallback –Ω–∞ orders.items_json.
function fetchOrderItems(orderId, cb) {
  const sqlFull = `
    SELECT
      oi.id                        AS order_item_id,
      oi.quantity,
      oi.unit_price                AS price,

      p.pos,
      COALESCE(p.title,'–¢–æ–≤–∞—Ä')    AS title,
      COALESCE(p.discount,0)       AS discount,

      COALESCE(mat.name, p.material) AS material_name,
      v.volume                     AS volume_label,
      v.ml                         AS ml,
      col.color_name               AS color_name,

      GROUP_CONCAT(pp.url)         AS photos
    FROM order_items oi
    LEFT JOIN products       p   ON p.id = oi.product_id
    LEFT JOIN materials      mat ON mat.id = p.material_id
    LEFT JOIN volumes        v   ON v.id = COALESCE(oi.volume_id, p.volume_id)
    LEFT JOIN colors         col ON col.id = COALESCE(oi.color_id,  p.color_id)
    LEFT JOIN product_photos pp  ON pp.product_id = p.id
    WHERE oi.order_id = ?
    GROUP BY oi.id
    ORDER BY oi.id
  `;

  const sqlSimple = `
    SELECT
      oi.id                      AS order_item_id,
      oi.quantity,
      oi.unit_price              AS price,
      p.pos,
      COALESCE(p.title,'–¢–æ–≤–∞—Ä')  AS title,
      COALESCE(p.discount,0)     AS discount
    FROM order_items oi
    LEFT JOIN products p ON p.id = oi.product_id
    WHERE oi.order_id = ?
    ORDER BY oi.id
  `;

  // 1) –ü—Ä–æ–±—É—î–º–æ –ø–æ–≤–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç –∑ —Ñ–æ—Ç–æ
  db.all(sqlFull, [orderId], (e, rows) => {
    if (e) {
      // 2) –Ø–∫—â–æ –Ω–µ–º–∞—î —è–∫–∏—Ö–æ—Å—å —Ç–∞–±–ª–∏—Ü—å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ product_photos / volumes / colors / materials) ‚Äî –ø—Ä–æ—Å—Ç–∏–π –±–µ–∑ —Ñ–æ—Ç–æ
      if (/no such table:/i.test(e.message) && !/order_items/i.test(e.message)) {
        return db.all(sqlSimple, [orderId], (e2, rows2) => {
          if (e2) {
            // 3) –Ø–∫—â–æ –Ω–µ–º–∞—î –Ω–∞–≤—ñ—Ç—å order_items ‚Äî fallback –Ω–∞ items_json
            if (/no such table:\s*order_items/i.test(e2.message)) {
              return hasColumn('orders','items_json').then(exists => {
                if (!exists) return cb(null, []);
                db.get(`SELECT items_json FROM orders WHERE id=?`, [orderId], (e3, row) => {
                  if (e3 || !row || !row.items_json) return cb(null, []);
                  try {
                    const parsed = JSON.parse(row.items_json);
                    const items = Array.isArray(parsed) ? parsed.map(it => ({
                      pos: it.pos || it.sku || it.code || '',
                      title: it.title || it.name || '–¢–æ–≤–∞—Ä',
                      photos: Array.isArray(it.photos) ? it.photos.map(normUrl) : (it.photo ? [normUrl(it.photo)] : []),
                      quantity: Number(it.quantity || it.qty || 1),
                      price: Number(it.price || it.unit_price || 0),
                      discount: Number(it.discount || 0),
                      material_name: it.material_name || it.material || null,
                      volume_label: it.volume_label || it.volume || (it.ml ? `${it.ml} –º–ª` : null),
                      ml: it.ml || null,
                      color_name: it.color_name || it.color || null
                    })) : [];
                    return cb(null, items);
                  } catch {
                    return cb(null, []);
                  }
                });
              });
            }
            // —ñ–Ω—à–∞ –ø–æ–º–∏–ª–∫–∞ ‚Äî –±–µ–∑ —Ñ–æ—Ç–æ
            console.error('fetchOrderItems(simple) SQL error:', e2.message);
            return cb(null, []);
          }
          const items2 = (rows2 || []).map(r => ({
            pos: r.pos,
            title: r.title,
            photos: [], // –±–µ–∑ product_photos
            quantity: Number(r.quantity || 0),
            price: Number(r.price || 0),
            discount: Number(r.discount || 0),
            material_name: null,
            volume_label: null,
            ml: null,
            color_name: null
          }));
          return cb(null, items2);
        });
      }
      // —ñ–Ω—à–∞ –ø–æ–º–∏–ª–∫–∞
      console.error('fetchOrderItems(full) SQL error:', e.message);
      return cb(null, []);
    }

    // –£–°–ü–Ü–•: –º–∞—î–º–æ photos —á–µ—Ä–µ–∑ GROUP_CONCAT ‚Üí –º–∞—Å–∏–≤
    const items = (rows || []).map(r => ({
      pos: r.pos,
      title: r.title,
      photos: r.photos ? r.photos.split(',').map(normUrl) : [],
      quantity: Number(r.quantity || 0),
      price: Number(r.price || 0),
      discount: Number(r.discount || 0),
      material_name: r.material_name || null,
      volume_label: r.volume_label || null,
      ml: r.ml || null,
      color_name: r.color_name || null
    }));
    cb(null, items);
  });
}


/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 * ¬´–Ü–°–¢–û–†–Ü–Ø –ó–ê–ú–û–í–õ–ï–ù–¨¬ª: –µ–Ω–¥–ø–æ—ó–Ω—Ç–∏ –∑ items
 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

// 1) –ü–µ—Ä—à–∏–π, —è–∫–∏–π —Ñ—Ä–æ–Ω—Ç –≤–∏–∫–ª–∏–∫–∞—î
app.get('/api/my/orders', async (req, res) => {
  if (!req.session || !req.session.userId) return res.status(401).json({ error: 'Not logged in' });
  try {
    const rows = await fetchOrdersListForUser(req.session.userId);
    if (!rows.length) return res.json({ orders: [] });

    let pending = rows.length;
    const out = [];
    rows.forEach(o => {
      fetchOrderItems(o.id, (e2, items) => {
        if (e2) return res.status(500).json({ error: e2.message });
        out.push({
          id: o.id,
          created_at: o.created_at,
          status: 'new', // —É —Å—Ö–µ–º—ñ –∫–æ–ª–æ–Ω–∫–∏ status –Ω–µ–º–∞—î
          total: Number(o.total || 0),
          address: [o.city, o.branch].filter(Boolean).join(', '),
          comment: o.comment || '',
          items_count: items.length,
          items
        });
        if (--pending === 0) {
          out.sort((a,b)=> new Date(b.created_at || 0) - new Date(a.created_at || 0));
          res.json({ orders: out });
        }
      });
    });
  } catch (e) {
    console.error('/api/my/orders error:', e.message);
    res.status(500).json({ error: 'Orders fetch error' });
  }
});

// 2) Fallback –∑ —Ç–∞–∫–∏–º —Å–∞–º–∏–º —Ñ–æ—Ä–º–∞—Ç–æ–º
app.get('/api/orders', async (req, res) => {
  if (!req.session || !req.session.userId) return res.status(401).json({ error: 'Not logged in' });
  try {
    const rows = await fetchOrdersListForUser(req.session.userId);
    if (!rows.length) return res.json({ orders: [] });

    let pending = rows.length;
    const out = [];
    rows.forEach(o => {
      fetchOrderItems(o.id, (e2, items) => {
        if (e2) return res.status(500).json({ error: e2.message });
        out.push({
          id: o.id,
          created_at: o.created_at,
          status: 'new',
          total: Number(o.total || 0),
          address: [o.city, o.branch].filter(Boolean).join(', '),
          comment: o.comment || '',
          items_count: items.length,
          items
        });
        if (--pending === 0) {
          out.sort((a,b)=> new Date(b.created_at || 0) - new Date(a.created_at || 0));
          res.json({ orders: out });
        }
      });
    });
  } catch (e) {
    console.error('/api/orders error:', e.message);
    res.status(500).json({ error: 'Orders fetch error' });
  }
});

// (–æ–ø—Ü—ñ–π–Ω–æ) –õ–∏—à–µ –ø–æ–∑–∏—Ü—ñ—ó –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
app.get('/api/orders/:id/items', (req, res) => {
  if (!req.session || !req.session.userId) return res.status(401).json({ error: 'Not logged in' });
  const id = Number(req.params.id);
  fetchOrderItems(id, (e, items) => {
    if (e) return res.status(500).json({ error: e.message });
    res.json({ items });
  });
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 * –°–¢–ê–†–¢
 * ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`üöÄ Listening on http://localhost:${PORT}`));
